{% extends "base.html" %}

{% block title %}Learning Library{% endblock %}

{% block content %}
<!-- Hero Section (Above the Fold) -->
<section class="hero">
    <!-- Search Bar -->
    <div class="hero-search">
        <input type="text" id="search-input" placeholder="Search videos, papers, podcasts..." autocomplete="off">
        <button id="search-btn">Search</button>
        <button id="clear-search" style="display: none;">Clear</button>
    </div>

    <!-- AI Chat Input -->
    <div class="hero-chat">
        <input type="text" id="chat-input" placeholder="Ask AI: What should I learn about transformers?">
        <button id="chat-btn">Ask</button>
    </div>

    <!-- Docent Desk -->
    <div class="docent-desk">
        <button id="docent-btn" class="docent-icon" title="Help &amp; API Info">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <span>docent desk</span>
        </button>
    </div>
</section>

<!-- Search Results (Hidden by default) -->
<div id="search-results" class="search-results" style="display: none;"></div>

<!-- Chat Messages (Hidden by default, expands when chat is used) -->
<div id="chat-container" class="chat-container-expandable" style="display: none;">
    <div id="chat-messages" class="chat-messages"></div>
</div>

<!-- Docent Modal -->
<div id="docent-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <button class="modal-close" id="docent-close">&times;</button>
        <h2>Welcome to the Learning Library</h2>

        <div class="docent-section">
            <h3>For Humans</h3>
            <ul>
                <li><strong>Search</strong> - Find content by keyword across {{ total_entries }} items</li>
                <li><strong>AI Chat</strong> - Ask questions, get personalized recommendations</li>
                <li><strong>Browse</strong> - Scroll down to explore by topic, format, or channel</li>
            </ul>
        </div>

        <div class="docent-section">
            <h3>For AI Agents</h3>
            <ul>
                <li><a href="/library.json">library.json</a> - Full index ({{ total_entries }} items)</li>
                <li><a href="/llms.txt">llms.txt</a> - Agent discovery guide</li>
                <li><a href="/.well-known/ai.json">ai.json</a> - API capabilities</li>
                <li><a href="/sitemap.xml">sitemap.xml</a> - All pages</li>
            </ul>
        </div>

        <div class="docent-section">
            <h3>API Access</h3>
            <p>REST API: <code>https://youtube-library-docent.dlkarpay.workers.dev/api/</code></p>
            <ul class="api-endpoints">
                <li><code>GET /api/search?q=query</code></li>
                <li><code>GET /api/recommend?topic=ai-ml</code></li>
                <li><code>GET /api/whats-new?days=7</code></li>
                <li><code>POST /api/chat</code></li>
            </ul>
        </div>

        <div class="docent-section">
            <h3>Content</h3>
            <p>{{ video_count }} videos • {{ paper_count }} papers • {{ podcast_count }} podcasts • {{ blog_count }} blogs</p>
        </div>
    </div>
</div>

<!-- Below the Fold: Browse Interface -->
<div id="library-content">
    <div class="filters">
        <!-- Domain Filter Toggle -->
        <div class="filter-group">
            <h3>Domain
                <nav class="domain-filter" aria-label="Domain filter">
                    <a href="#" data-domain="all" class="active">All</a>
                    <a href="#" data-domain="computer-science">CS</a>
                    <a href="#" data-domain="law">Law</a>
                </nav>
            </h3>
        </div>

        <div class="filter-group">
            <h3>Topics</h3>
            <div class="tags">
                {% for topic in topics %}
                <a href="topics/{{ topic }}.html" class="tag">{{ topic }}</a>
                {% endfor %}
            </div>
        </div>

        <div class="filter-group">
            <h3>Format</h3>
            <div class="tags">
                {% for fmt in formats %}
                <a href="#" class="tag" data-filter="format" data-value="{{ fmt }}">{{ fmt }}</a>
                {% endfor %}
            </div>
        </div>

        <div class="filter-group">
            <h3>Difficulty</h3>
            <div class="tags">
                {% for diff in difficulties %}
                <a href="#" class="tag" data-filter="difficulty" data-value="{{ diff }}">{{ diff }}</a>
                {% endfor %}
            </div>
        </div>

        {% if channels %}
        <div class="filter-group">
            <h3>Channels</h3>
            <div class="tags">
                {% for channel in channels %}
                <a href="channels/{{ channel.slug }}.html" class="tag">{{ channel.name }}</a>
                {% endfor %}
                {% if channels|length >= 10 %}
                <a href="channels/index.html" class="tag" style="background: var(--accent);">All channels...</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <div class="entries">
        {% for entry in entries %}
        <article class="entry-card domain-{{ entry.domain|default('computer-science') }} {% if entry.content_type == 'paper' %}paper-card{% elif entry.content_type == 'podcast' %}podcast-card{% elif entry.content_type == 'blog' %}blog-card{% elif entry.content_type == 'legal' %}legal-card{% elif entry.content_type == 'law-journal' %}journal-card{% endif %}"
                 data-topics="{{ entry.facets.topics|join(',') }}"
                 data-format="{{ entry.facets.format }}"
                 data-difficulty="{{ entry.facets.difficulty }}"
                 data-type="{{ entry.content_type|default('video') }}"
                 data-domain="{{ entry.domain|default('computer-science') }}">
            <div class="entry-badges">
                {% if entry.content_type == 'paper' %}
                <span class="content-type-badge paper-badge">Paper</span>
                {% elif entry.content_type == 'podcast' %}
                <span class="content-type-badge podcast-badge">Podcast</span>
                {% elif entry.content_type == 'blog' %}
                <span class="content-type-badge blog-badge">Blog</span>
                {% elif entry.content_type == 'legal' %}
                <span class="content-type-badge legal-badge">Legal</span>
                {% elif entry.content_type == 'law-journal' %}
                <span class="content-type-badge journal-badge">Journal</span>
                {% endif %}
                <span class="domain-badge {{ entry.domain|default('computer-science') }}">{{ entry.domain|default('CS')|replace('computer-science', 'CS')|replace('law', 'Law') }}</span>
            </div>
            {% if entry.content_type == 'paper' %}
            <h2><a href="papers/{{ entry._filename }}.html">{{ entry.title }}</a></h2>
            {% elif entry.content_type == 'podcast' %}
            <h2><a href="podcasts/{{ entry._filename }}.html">{{ entry.title }}</a></h2>
            {% elif entry.content_type == 'blog' %}
            <h2><a href="blogs/{{ entry._filename }}.html">{{ entry.title }}</a></h2>
            {% elif entry.content_type == 'legal' %}
            <h2><a href="legal/{{ entry._filename }}.html">{{ entry.title }}</a></h2>
            {% elif entry.content_type == 'law-journal' %}
            <h2><a href="journals/{{ entry._filename }}.html">{{ entry.title }}</a></h2>
            {% else %}
            <h2><a href="transcripts/{{ entry._filename }}.html">{{ entry.title }}</a></h2>
            {% endif %}
            <div class="entry-meta">
                {% if entry.duration_seconds %}
                <span class="duration">{{ entry.duration_seconds|format_duration }}</span>
                •
                {% endif %}
                {% if entry.upvotes %}
                <span class="upvotes">▲ {{ entry.upvotes }}</span>
                •
                {% endif %}
                <span class="topic">{{ entry.facets.topics|join(', ') }}</span>
                •
                <span class="difficulty">{{ entry.facets.difficulty }}</span>
                •
                <span class="date">{{ entry.added_date }}</span>
            </div>
            {% if entry.summary %}
            <div class="entry-summary">
                <ul>
                    {% for point in entry.summary[:3] %}
                    <li>{{ point }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </article>
        {% endfor %}
    </div>
</div>

<script>
// Configuration
const CONFIG = {
    API_URL: 'https://youtube-library-api.dlkarpay.workers.dev'
};

// DOM Elements
const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');
const clearBtn = document.getElementById('clear-search');
const searchResults = document.getElementById('search-results');
const libraryContent = document.getElementById('library-content');
const chatInput = document.getElementById('chat-input');
const chatBtn = document.getElementById('chat-btn');
const chatContainer = document.getElementById('chat-container');
const chatMessages = document.getElementById('chat-messages');
const docentBtn = document.getElementById('docent-btn');
const docentModal = document.getElementById('docent-modal');
const docentClose = document.getElementById('docent-close');

let libraryData = null;

// === Utility Functions ===
function formatDuration(seconds) {
    if (!seconds) return '0m';
    if (seconds < 60) return `${seconds}s`;
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    return `${h}h ${m}m`;
}

async function loadLibraryData() {
    if (libraryData) return libraryData;
    try {
        const response = await fetch('/library.json');
        libraryData = await response.json();
        return libraryData;
    } catch (err) {
        console.error('Failed to load library.json:', err);
        return null;
    }
}

function clientSideSearch(query, entries) {
    const terms = query.toLowerCase().split(/\s+/).filter(t => t.length > 1);
    if (terms.length === 0) return [];

    const scored = entries.map(entry => {
        let score = 0;
        const title = (entry.title || '').toLowerCase();
        const summary = (entry.summary || []).join(' ').toLowerCase();
        const topics = (entry.facets?.topics || []).join(' ').toLowerCase();

        for (const term of terms) {
            if (title.includes(term)) score += 10;
            if (summary.includes(term)) score += 5;
            if (topics.includes(term)) score += 3;
        }
        return { entry, score };
    });

    return scored
        .filter(s => s.score > 0)
        .sort((a, b) => b.score - a.score)
        .slice(0, 20)
        .map(s => s.entry);
}

function getContentUrl(entry) {
    const type = entry.content_type || 'video';
    const filename = entry._filename || entry.slug;
    if (type === 'paper') return `papers/${filename}.html`;
    if (type === 'podcast') return `podcasts/${filename}.html`;
    if (type === 'blog') return `blogs/${filename}.html`;
    return `transcripts/${filename}.html`;
}

// === Search ===
async function performSearch() {
    const query = searchInput.value.trim();
    if (!query) return;

    searchResults.innerHTML = '<p class="search-loading">Searching...</p>';
    searchResults.style.display = 'block';
    libraryContent.style.display = 'none';
    clearBtn.style.display = 'inline-block';

    try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=20`);
        if (!response.ok) throw new Error('Server not available');
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        renderSearchResults(data.results, data.total, query);
    } catch (err) {
        // Fallback to client-side search
        const data = await loadLibraryData();
        if (!data?.entries) {
            searchResults.innerHTML = '<p class="search-empty">Could not load library data.</p>';
            return;
        }
        const results = clientSideSearch(query, data.entries);
        renderSearchResults(results, results.length, query, true);
    }
}

function renderSearchResults(results, total, query, isClientSide = false) {
    if (results.length === 0) {
        searchResults.innerHTML = '<p class="search-empty">No results found. Try different keywords.</p>';
        return;
    }

    searchResults.innerHTML = `
        <p class="search-count">Found ${total} result${total !== 1 ? 's' : ''} for "${query}"</p>
        ${results.map(r => `
            <article class="search-result-card">
                <h2><a href="${getContentUrl(r)}">${r.title}</a></h2>
                <div class="entry-meta">
                    <span class="duration">${formatDuration(r.duration_seconds)}</span>
                    • <span class="topic">${(r.facets?.topics || []).join(', ')}</span>
                    • <span class="difficulty">${r.facets?.difficulty || ''}</span>
                </div>
                ${r.summary?.length ? `
                    <div class="entry-summary">
                        <ul>${r.summary.slice(0, 2).map(s => `<li>${s}</li>`).join('')}</ul>
                    </div>
                ` : ''}
            </article>
        `).join('')}
    `;
}

function clearSearch() {
    searchInput.value = '';
    searchResults.style.display = 'none';
    searchResults.innerHTML = '';
    libraryContent.style.display = 'block';
    clearBtn.style.display = 'none';
}

searchBtn.addEventListener('click', performSearch);
searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(); });
clearBtn.addEventListener('click', clearSearch);

// === Chat ===
function addChatMessage(content, role) {
    const msgDiv = document.createElement('div');
    msgDiv.className = `chat-message ${role}`;
    msgDiv.innerHTML = `<p>${content}</p>`;
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function sendChatMessage() {
    const message = chatInput.value.trim();
    if (!message) return;

    // Show chat container
    chatContainer.style.display = 'block';
    addChatMessage(message, 'user');
    chatInput.value = '';

    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'chat-message assistant loading';
    loadingDiv.innerHTML = '<p>Thinking...</p>';
    chatMessages.appendChild(loadingDiv);

    // Get relevant content via search
    const data = await loadLibraryData();
    const searchResults = data ? clientSideSearch(message, data.entries).slice(0, 10) : [];

    let context = '';
    if (searchResults.length > 0) {
        context = '\n\nRelevant content from the library:\n' + searchResults.map((r, i) =>
            `${i+1}. "${r.title}" (${formatDuration(r.duration_seconds)}, ${r.facets?.difficulty || 'intermediate'})\n   Topics: ${(r.facets?.topics || []).join(', ')}`
        ).join('\n');
    }

    const systemPrompt = `You are a helpful assistant for a learning library. Keep responses concise (2-4 recommendations max). Use **bold** for titles.`;
    const userPrompt = `User query: ${message}${context}\n\nRecommend the most relevant content.`;

    try {
        const response = await fetch(`${CONFIG.API_URL}/api/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: 'gpt-oss:120b-cloud',
                messages: [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: userPrompt }
                ],
                stream: false
            })
        });

        loadingDiv.remove();
        const result = await response.json();
        const aiResponse = result.message?.content || result.response || 'Sorry, I could not generate a response.';

        let html = aiResponse
            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
            .replace(/\n/g, '<br>');

        if (searchResults.length > 0) {
            html += '<div class="chat-videos"><strong>Related:</strong><ul>';
            searchResults.slice(0, 5).forEach(v => {
                html += `<li><a href="${getContentUrl(v)}">${v.title}</a></li>`;
            });
            html += '</ul></div>';
        }

        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message assistant';
        msgDiv.innerHTML = html;
        chatMessages.appendChild(msgDiv);

    } catch (err) {
        loadingDiv.remove();
        if (searchResults.length > 0) {
            let html = `<p>I found ${searchResults.length} relevant items:</p><ul>`;
            searchResults.slice(0, 5).forEach(v => {
                html += `<li><a href="${getContentUrl(v)}">${v.title}</a></li>`;
            });
            html += '</ul>';
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-message assistant';
            msgDiv.innerHTML = html;
            chatMessages.appendChild(msgDiv);
        } else {
            addChatMessage('Could not connect to AI assistant.', 'assistant');
        }
    }
}

chatBtn.addEventListener('click', sendChatMessage);
chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });

// === Docent Modal ===
docentBtn.addEventListener('click', () => { docentModal.style.display = 'flex'; });
docentClose.addEventListener('click', () => { docentModal.style.display = 'none'; });
docentModal.addEventListener('click', (e) => { if (e.target === docentModal) docentModal.style.display = 'none'; });

// === Domain Filtering ===
let activeDomain = 'all';
document.querySelectorAll('.domain-filter a[data-domain]').forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        // Update active state
        document.querySelectorAll('.domain-filter a').forEach(a => a.classList.remove('active'));
        link.classList.add('active');
        activeDomain = link.dataset.domain;

        // Filter cards
        document.querySelectorAll('.entry-card').forEach(card => {
            const cardDomain = card.dataset.domain || 'computer-science';
            if (activeDomain === 'all' || cardDomain === activeDomain) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    });
});

// === Filtering ===
document.querySelectorAll('.tag[data-filter]').forEach(tag => {
    tag.addEventListener('click', (e) => {
        e.preventDefault();
        tag.classList.toggle('active');

        const activeFilters = {};
        document.querySelectorAll('.tag.active[data-filter]').forEach(t => {
            const f = t.dataset.filter;
            if (!activeFilters[f]) activeFilters[f] = [];
            activeFilters[f].push(t.dataset.value);
        });

        document.querySelectorAll('.entry-card').forEach(card => {
            let show = true;
            // Check domain filter first
            const cardDomain = card.dataset.domain || 'computer-science';
            if (activeDomain !== 'all' && cardDomain !== activeDomain) {
                show = false;
            }
            // Then check other filters
            if (show) {
                for (const [filterName, values] of Object.entries(activeFilters)) {
                    const cardValue = card.dataset[filterName];
                    if (!values.some(v => cardValue.includes(v))) {
                        show = false;
                        break;
                    }
                }
            }
            card.style.display = show ? 'block' : 'none';
        });
    });
});
</script>
{% endblock %}
